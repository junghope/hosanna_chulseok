<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°„ë‹¨ ì¶œì„ ì²´í¬</title>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyA0xP2CkLBXMLEpmeWcdpuqPFebI4aqCEc",
            authDomain: "hosanna-chulcheck.firebaseapp.com",
            projectId: "hosanna-chulcheck",
            storageBucket: "hosanna-chulcheck.firebasestorage.app",
            messagingSenderId: "895906682359",
            appId: "1:895906682359:web:016536e1fe2fa92b1ecaf2"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì •
        window.db = db;
        window.firestore = { collection, addDoc, onSnapshot, query, orderBy, where, getDocs, deleteDoc, doc };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }
        
        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #4facfe;
            color: white;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 18px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #ccc;
            transform: none;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            font-size: 22px;
            padding: 25px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 3px dashed #4facfe;
        }
        
        #qr-code {
            margin: 20px auto;
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .url-display {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .attendance-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .name {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .time {
            color: #666;
            font-size: 0.9em;
        }
        
        .stats-summary {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stats-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #4facfe;
        }
        
        .stats-label {
            color: #666;
            font-size: 1.1em;
            margin-top: 5px;
        }
        
        .user-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .attendance-main {
            text-align: center;
            padding: 20px 0;
        }
        
        .big-title {
            font-size: 2em;
            margin-bottom: 30px;
            color: #4facfe;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ ì¶œì„ ì²´í¬</h1>
            <p>QR ìŠ¤ìº”í•˜ë©´ ë°”ë¡œ ì´ í˜ì´ì§€ë¡œ!</p>
        </div>
        
        <div class="content">
            <div id="connection-status" class="connection-status disconnected">
                Firebase ì—°ê²° ì¤‘...
            </div>
            
            <!-- URL íŒŒë¼ë¯¸í„°ë¡œ ì¶œì„ ëª¨ë“œ í™•ì¸ -->
            <div id="attendance-mode" class="attendance-main hidden">
                <div class="big-title">âœ… ì¶œì„í•˜ê¸°</div>
                
                <div class="form-group" id="name-section">
                    <label for="user-name">ì´ë¦„</label>
                    <input type="text" id="user-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" autofocus>
                </div>
                
                <div id="saved-user" class="user-info hidden">
                    <p><strong id="saved-name"></strong>ë‹˜ìœ¼ë¡œ ì¶œì„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    <button class="btn btn-success" onclick="recordAttendance()" id="quick-attend-btn">âœ… ì¶œì„í•˜ê¸°</button>
                    <button class="btn" onclick="changeUser()">ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì¶œì„</button>
                </div>
                
                <button class="btn btn-success" onclick="recordAttendance()" id="attend-btn">âœ… ì¶œì„í•˜ê¸°</button>
                
                <div id="result-message"></div>
            </div>
            
            <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ (QR ì½”ë“œ ìƒì„±ìš©) -->
            <div id="admin-login" class="attendance-main">
                <div class="big-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>
                <p style="color: #666; margin-bottom: 20px;">QR ì½”ë“œ ìƒì„± ë° ë°ì´í„° ê´€ë¦¬ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                
                <div class="form-group">
                    <label for="admin-password">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" autofocus>
                    <small style="color: #666;">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸: hosanna123</small>
                </div>
                
                <button class="btn" onclick="checkAdminPassword()">ë¡œê·¸ì¸</button>
                
                <div id="login-message"></div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button class="btn" onclick="goToStats()" style="background: #6c757d;">ğŸ“Š í†µê³„ë§Œ ë³´ê¸°</button>
                </div>
            </div>

            <!-- ì¼ë°˜ ì‚¬ìš©ììš© í†µê³„ (ì½ê¸° ì „ìš©) -->
            <div id="stats-only-mode" class="hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="color: #4facfe; font-weight: 600;">ğŸ“Š ì¶œì„ í†µê³„ (ì½ê¸° ì „ìš©)</span>
                    <button style="margin-left: 10px; padding: 5px 10px; border: none; background: #28a745; color: white; border-radius: 5px; cursor: pointer;" onclick="goBackToAttendance()">ğŸ”™ ì¶œì„í•˜ê¸°</button>
                    <button style="margin-left: 5px; padding: 5px 10px; border: none; background: #4facfe; color: white; border-radius: 5px; cursor: pointer;" onclick="goToAdminLogin()">ğŸ” ê´€ë¦¬ì</button>
                </div>
                
                <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <small style="color: #1976d2;">ğŸ‘€ í˜„ì¬ ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤. ìˆ˜ì •ì€ ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</small>
                </div>
                
                <div class="stats-summary">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div class="stats-number" id="total-count-public">0</div>
                            <div class="stats-label">ì´ ì¶œì„ì</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="stats-number" id="late-count-public" style="color: #ff6b6b;">0</div>
                            <div class="stats-label">ì§€ê°ì</div>
                        </div>
                        <div style="text-align: center;">
                            <div class="stats-number" id="total-fine-public" style="color: #ff9f43;">0ì›</div>
                            <div class="stats-label">ì´ ë²Œê¸ˆ</div>
                        </div>
                    </div>
                </div>
                
                <div class="attendance-list">
                    <h3 style="color: #4facfe; margin-bottom: 15px;">ğŸ“Š ì¶œì„ í˜„í™©</h3>
                    <div id="attendance-list-public" class="loading">ì¶œì„ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- ê´€ë¦¬ì ì „ìš© ëª¨ë“œ -->
            <div id="admin-mode" class="hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <span style="color: #4facfe; font-weight: 600;">ğŸ” ê´€ë¦¬ì ëª¨ë“œ</span>
                    <button style="margin-left: 10px; padding: 5px 10px; border: none; background: #ff6b6b; color: white; border-radius: 5px; cursor: pointer;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showTab('qr')">QR ì½”ë“œ</button>
                    <button class="tab-btn" onclick="showTab('stats')">ì˜¤ëŠ˜ í†µê³„</button>
                    <button class="tab-btn" onclick="showTab('history')">ì´ì „ í†µê³„</button>
                </div>
                
                <!-- QR ì½”ë“œ íƒ­ -->
                <div id="qr-tab" class="tab-content active">
                    <!-- ëª¨ì„ ì‹œê°„ ì„¤ì • -->
                    <div style="background: #fff3cd; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #856404; margin-bottom: 15px;">â° ëª¨ì„ ì‹œê°„ ì„¤ì •</h3>
                        <div class="form-group">
                            <label for="meeting-time">ì˜¤ëŠ˜ ëª¨ì„ ì‹œê°„</label>
                            <input type="datetime-local" id="meeting-time" style="margin-bottom: 10px;">
                            <button class="btn" onclick="setMeetingTime()" style="padding: 10px; font-size: 16px;">ì‹œê°„ ì„¤ì •</button>
                        </div>
                        <div id="current-meeting-time" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>
                    
                    <!-- ì§€ê°ë¹„ ì„¤ì • -->
                    <div style="background: #ffeaa7; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #d63031; margin-bottom: 15px;">ğŸ’° ì§€ê°ë¹„ ì„¤ì •</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="fine-min-unit">ìµœì†Œ ë‹¨ìœ„ (ë¶„)</label>
                                <input type="number" id="fine-min-unit" value="1" min="1" style="padding: 10px; font-size: 16px;">
                                <small style="color: #666; font-size: 12px;">ì§€ê°ì‹œê°„ì„ ëª‡ ë¶„ ë‹¨ìœ„ë¡œ ê³„ì‚°í• ì§€ ì„¤ì •</small>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="fine-per-minute">ë¶„ë‹¹ ë²Œê¸ˆ (ì›)</label>
                                <input type="number" id="fine-per-minute" value="1000" min="0" step="100" style="padding: 10px; font-size: 16px;">
                                <small style="color: #666; font-size: 12px;">ìœ„ ë‹¨ìœ„ë‹¹ ë²Œê¸ˆ ê¸ˆì•¡</small>
                            </div>
                        </div>
                        <button class="btn" onclick="saveFineSettings()" style="padding: 10px; font-size: 16px; background: linear-gradient(135deg, #e17055 0%, #d63031 100%);">ğŸ’° ì§€ê°ë¹„ ì„¤ì •</button>
                        <div id="current-fine-settings" style="margin-top: 10px; font-weight: 600;"></div>
                        
                        <!-- ì˜ˆì‹œ ì„¤ëª… -->
                        <div style="background: rgba(255,255,255,0.3); padding: 15px; border-radius: 10px; margin-top: 15px;">
                            <h4 style="color: #2d3436; margin-bottom: 10px;">ğŸ’¡ ì„¤ì • ì˜ˆì‹œ</h4>
                            <ul style="color: #2d3436; margin: 0; padding-left: 20px; font-size: 14px;">
                                <li><strong>1ë¶„ë‹¹ 1,000ì›:</strong> 3ë¶„ ì§€ê° â†’ 3,000ì›</li>
                                <li><strong>5ë¶„ë‹¹ 2,000ì›:</strong> 7ë¶„ ì§€ê° â†’ 4,000ì› (5ë¶„ Ã— 2íšŒ = 10ë¶„ ê¸°ì¤€)</li>
                                <li><strong>10ë¶„ë‹¹ 5,000ì›:</strong> 23ë¶„ ì§€ê° â†’ 15,000ì› (10ë¶„ Ã— 3íšŒ = 30ë¶„ ê¸°ì¤€)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- ê³ ì • QR ì½”ë“œ -->
                    <div class="qr-container">
                        <h3 style="color: #4facfe; margin-bottom: 10px;">ğŸ“ ê³ ì • ì¶œì„ QR ì½”ë“œ</h3>
                        <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                            âœ… <strong>ì´ QR ì½”ë“œëŠ” ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</strong><br>
                            í•œ ë²ˆ ì¸ì‡„í•´ì„œ ë¬¸ì— ë¶™ì—¬ë‘ë©´ ê³„ì† ì‚¬ìš© ê°€ëŠ¥í•´ìš”!
                        </p>
                        <div id="qr-code"></div>
                        <p style="margin-top: 15px; color: #28a745; font-weight: 600;">
                            ğŸ“Œ QR ìŠ¤ìº” â†’ ìë™ìœ¼ë¡œ ì¶œì„ í˜ì´ì§€ ì´ë™
                        </p>
                    </div>
                    
                    <div class="url-display">
                        <strong>ê³ ì • URL:</strong> <span id="attendance-url"></span>
                    </div>
                    
                    <button class="btn" onclick="printQR()">ğŸ–¨ï¸ QR ì½”ë“œ ì¸ì‡„í•˜ê¸°</button>
                    <button class="btn" onclick="copyUrl()">ğŸ“‹ URL ë³µì‚¬í•˜ê¸°</button>
                    
                    <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="color: #28a745; margin-bottom: 10px;">ğŸ’¡ ì‚¬ìš© íŒ</h4>
                        <ul style="color: #155724; margin: 0; padding-left: 20px;">
                            <li>QR ì½”ë“œë¥¼ í•œ ë²ˆë§Œ ì¸ì‡„í•´ì„œ ëª¨ì„ ì¥ì†Œì— ë¶™ì—¬ì£¼ì„¸ìš”</li>
                            <li>ë§¤ ëª¨ì„ë§ˆë‹¤ ìœ„ì˜ "ëª¨ì„ ì‹œê°„"ë§Œ ìƒˆë¡œ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤</li>
                            <li>QR ì½”ë“œëŠ” ì ˆëŒ€ ë°”ë€Œì§€ ì•Šìœ¼ë‹ˆ ì•ˆì‹¬í•˜ì„¸ìš”!</li>
                        </ul>
                    </div>
                </div>
                
                <!-- í†µê³„ íƒ­ - ê´€ë¦¬ììš© (ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ í¬í•¨) -->
                <div id="stats-tab" class="tab-content">
                    <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <small style="color: #2e7d32;">ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ: ì´ë¦„ í´ë¦­ ì‹œ ìˆ˜ì •, ë²„íŠ¼ìœ¼ë¡œ ì§€ê°ì‹œê°„ ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥</small>
                    </div>
                    
                    <div class="stats-summary">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div class="stats-number" id="total-count">0</div>
                                <div class="stats-label">ì´ ì¶œì„ì</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="stats-number" id="late-count" style="color: #ff6b6b;">0</div>
                                <div class="stats-label">ì§€ê°ì</div>
                            </div>
                            <div style="text-align: center;">
                                <div class="stats-number" id="total-fine" style="color: #ff9f43;">0ì›</div>
                                <div class="stats-label">ì´ ë²Œê¸ˆ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="attendance-list">
                        <h3 style="color: #4facfe; margin-bottom: 15px;">ğŸ“Š ìƒì„¸ ì¶œì„ ê¸°ë¡ (ìˆ˜ì • ê°€ëŠ¥)</h3>
                        <div id="attendance-list" class="loading">ì¶œì„ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                    
                    <button class="btn btn-danger" onclick="clearTodayData()">ğŸ—‘ï¸ ì˜¤ëŠ˜ ê¸°ë¡ ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)</button>
                </div>
                
                <!-- ì´ì „ í†µê³„ íƒ­ - ê´€ë¦¬ì ì „ìš© -->
                <div id="history-tab" class="tab-content">
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <small style="color: #1976d2;">ğŸ“Š ê³¼ê±° ì¶œì„ ê¸°ë¡ì„ ë‚ ì§œë³„/ì›”ë³„ë¡œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
                    </div>
                    
                    <!-- ì¡°íšŒ ì˜µì…˜ ì„ íƒ -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3 style="color: #4facfe; margin-bottom: 15px;">ğŸ” ì¡°íšŒ ì˜µì…˜</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <button class="btn" id="date-mode-btn" onclick="setHistoryMode('date')" 
                                    style="background: #4facfe; padding: 10px; font-size: 14px;">ğŸ“… ë‚ ì§œë³„ ì¡°íšŒ</button>
                            <button class="btn" id="month-mode-btn" onclick="setHistoryMode('month')" 
                                    style="background: #6c757d; padding: 10px; font-size: 14px;">ğŸ“† ì›”ë³„ ì¡°íšŒ</button>
                        </div>
                        
                        <!-- ë‚ ì§œë³„ ì¡°íšŒ -->
                        <div id="date-search" class="form-group">
                            <label for="search-date">ì¡°íšŒí•  ë‚ ì§œ</label>
                            <input type="date" id="search-date" style="margin-bottom: 10px;">
                            <button class="btn" onclick="searchByDate()" style="padding: 10px; font-size: 16px;">ğŸ” í•´ë‹¹ ë‚ ì§œ ì¡°íšŒ</button>
                        </div>
                        
                        <!-- ì›”ë³„ ì¡°íšŒ -->
                        <div id="month-search" class="form-group hidden">
                            <label for="search-month">ì¡°íšŒí•  ë…„/ì›”</label>
                            <input type="month" id="search-month" style="margin-bottom: 10px;">
                            <button class="btn" onclick="searchByMonth()" style="padding: 10px; font-size: 16px;">ğŸ“Š í•´ë‹¹ ì›” í†µê³„</button>
                        </div>
                    </div>
                    
                    <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
                    <div id="history-results" class="hidden">
                        <!-- ìš”ì•½ í†µê³„ -->
                        <div class="stats-summary">
                            <h3 style="color: #4facfe; margin-bottom: 15px;">ğŸ“Š <span id="history-period"></span> í†µê³„</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                                <div style="text-align: center;">
                                    <div class="stats-number" id="history-total-count">0</div>
                                    <div class="stats-label">ì´ ì¶œì„ì</div>
                                </div>
                                <div style="text-align: center;">
                                    <div class="stats-number" id="history-late-count" style="color: #ff6b6b;">0</div>
                                    <div class="stats-label">ì§€ê°ì</div>
                                </div>
                                <div style="text-align: center;">
                                    <div class="stats-number" id="history-total-fine" style="color: #ff9f43;">0ì›</div>
                                    <div class="stats-label">ì´ ë²Œê¸ˆ</div>
                                </div>
                                <div style="text-align: center;" id="history-unique-section">
                                    <div class="stats-number" id="history-unique-count" style="color: #6f42c1;">0</div>
                                    <div class="stats-label">ê³ ìœ  ì¸ì›</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ìƒì„¸ ê¸°ë¡ -->
                        <div class="attendance-list">
                            <h3 style="color: #4facfe; margin-bottom: 15px;">ğŸ“‹ ìƒì„¸ ê¸°ë¡</h3>
                            <div id="history-list" class="loading">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                        </div>
                        
                        <!-- ì›”ë³„ ì¡°íšŒ ì‹œ ì¶”ê°€ ì •ë³´ -->
                        <div id="monthly-details" class="hidden">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 20px;">
                                <h4 style="color: #4facfe; margin-bottom: 15px;">ğŸ“ˆ ì›”ë³„ ìƒì„¸ ë¶„ì„</h4>
                                <div id="monthly-breakdown"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ -->
                    <div id="history-placeholder" style="text-align: center; color: #666; padding: 40px;">
                        <h4>ğŸ“Š ì´ì „ í†µê³„</h4>
                        <p>ìœ„ì—ì„œ ë‚ ì§œë‚˜ ì›”ì„ ì„ íƒí•˜ì—¬ ê³¼ê±° ì¶œì„ ê¸°ë¡ì„ ì¡°íšŒí•˜ì„¸ìš”.</p>
                        <ul style="list-style: none; margin-top: 20px; color: #999;">
                            <li>ğŸ“… ë‚ ì§œë³„ ì¡°íšŒ: íŠ¹ì • ë‚ ì§œì˜ ì¶œì„ í˜„í™©</li>
                            <li>ğŸ“† ì›”ë³„ ì¡°íšŒ: í•œ ë‹¬ê°„ì˜ í†µê³„ ë° ë¶„ì„</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let savedUserName = localStorage.getItem('savedUserName') || '';
        let unsubscribe = null;
        let unsubscribeMeeting = null;
        let unsubscribeFineSettings = null; // ì§€ê°ë¹„ ì„¤ì • ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        let attendanceCount = 0;
        let currentUrl = window.location.href.split('?')[0]; // íŒŒë¼ë¯¸í„° ì œê±°í•œ ê¸°ë³¸ URL
        let isAdminLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
        let meetingTime = null;
        let autoRefreshTimer = null; // ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸
        
        // ì§€ê°ë¹„ ì„¤ì • (ê¸°ë³¸ê°’: 1ë¶„ë‹¹ 1000ì›)
        let fineSettings = {
            perMinute: 1000,  // 1ë¶„ë‹¹ ë²Œê¸ˆ
            minUnit: 1        // ìµœì†Œ ë‹¨ìœ„ (ë¶„)
        };
        
        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (ì›í•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ì„¸ìš”!)
        const ADMIN_PASSWORD = 'hosanna123';

        // ì•± ì´ˆê¸°í™”
        function initializeApp() {
            checkUrlParams();
            setupRealtimeListener();
            setupMeetingTimeListener();
            setupFineSettingsListener(); // ì§€ê°ë¹„ ì„¤ì • ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            loadMeetingTimeFromFirebase();
            loadFineSettingsFromFirebase(); // ì§€ê°ë¹„ ì„¤ì • ë¡œë“œ ì¶”ê°€
        }
        
        // ì¶œì„ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
        function goBackToAttendance() {
            // í˜ì´ì§€ ì œëª© ì›ë˜ëŒ€ë¡œ ë³µì›
            document.querySelector('.header h1').textContent = 'ğŸ“‹ ì¶œì„ ì²´í¬';
            document.querySelector('.header p').textContent = 'QR ìŠ¤ìº”í•˜ë©´ ë°”ë¡œ ì´ í˜ì´ì§€ë¡œ!';
            
            // ì¶œì„ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = currentUrl + '?action=attend';
        }
        
        // í†µê³„ ë³´ê¸° ë²„íŠ¼ ìƒì„± (ì¼ë°˜ ì‚¬ìš©ììš©)
        function showStatsButton() {
            const resultDiv = document.getElementById('result-message');
            const existingButton = document.getElementById('stats-btn');
            
            if (!existingButton) {
                resultDiv.innerHTML += `
                    <div style="margin-top: 20px;">
                        <button id="stats-btn" class="btn" onclick="goToStats()" style="background: #6c757d; font-size: 16px; padding: 15px;">
                            ğŸ“Š ì¶œì„ í˜„í™© ë³´ê¸°
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.
                        </p>
                    </div>
                `;
            }
        }
        
        // Firebaseì—ì„œ ëª¨ì„ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMeetingTimeFromFirebase() {
            if (!window.db) return;
            
            try {
                const today = new Date().toDateString();
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'meetings'),
                    window.firestore.where('date', '==', today)
                );
                
                const querySnapshot = await window.firestore.getDocs(q);
                
                if (!querySnapshot.empty) {
                    // ê°€ì¥ ìµœê·¼ ì„¤ì •ëœ ëª¨ì„ ì‹œê°„ ì°¾ê¸°
                    const meetings = [];
                    querySnapshot.forEach(doc => {
                        meetings.push(doc.data());
                    });
                    
                    // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
                    meetings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    meetingTime = meetings[0].meetingTime;
                    updateMeetingTimeDisplay();
                    
                    // ê´€ë¦¬ì í™”ë©´ì—ì„œ ì…ë ¥ë€ë„ ì—…ë°ì´íŠ¸
                    if (document.getElementById('meeting-time')) {
                        document.getElementById('meeting-time').value = meetingTime;
                    }
                }
            } catch (error) {
                console.error('ëª¨ì„ ì‹œê°„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
            }
        }
        
        // ëª¨ì„ ì‹œê°„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupMeetingTimeListener() {
            if (!window.db) return;

            const today = new Date().toDateString();
            const q = window.firestore.query(
                window.firestore.collection(window.db, 'meetings'),
                window.firestore.where('date', '==', today)
            );

            unsubscribeMeeting = window.firestore.onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    // ê°€ì¥ ìµœê·¼ ì„¤ì •ëœ ëª¨ì„ ì‹œê°„ ì°¾ê¸°
                    const meetings = [];
                    snapshot.forEach(doc => {
                        meetings.push(doc.data());
                    });
                    
                    // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ìµœê·¼ ê²ƒ ì„ íƒ
                    meetings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    meetingTime = meetings[0].meetingTime;
                    updateMeetingTimeDisplay();
                    
                    // ê´€ë¦¬ì í™”ë©´ì—ì„œ ì…ë ¥ë€ë„ ì—…ë°ì´íŠ¸
                    if (document.getElementById('meeting-time')) {
                        document.getElementById('meeting-time').value = meetingTime;
                    }
                }
            });
        }
        
        // ì´ë¦„ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)
        async function editName(recordId, currentName) {
            const newName = prompt('ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentName);
            if (!newName || newName === currentName) return;
            
            try {
                // Firestoreì—ì„œëŠ” ì§ì ‘ ì—…ë°ì´íŠ¸ê°€ ì–´ë ¤ìš°ë¯€ë¡œ ìƒˆ ë ˆì½”ë“œ ìƒì„± í›„ ê¸°ì¡´ ì‚­ì œ
                // ì‹¤ì œë¡œëŠ” admin SDKë‚˜ Cloud Functionsê°€ í•„ìš”í•˜ì§€ë§Œ, 
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì•Œë¦¼ë§Œ í‘œì‹œ
                showLoginAlert(`ì´ë¦„ ìˆ˜ì •: "${currentName}" â†’ "${newName}"\nì‹¤ì œ ìˆ˜ì •ì€ Firebase ì½˜ì†”ì—ì„œ ì§ì ‘ í•´ì£¼ì„¸ìš”.`, 'warning');
            } catch (error) {
                console.error('ì´ë¦„ ìˆ˜ì • ì‹¤íŒ¨:', error);
                showLoginAlert('ì´ë¦„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }
        
        // ì§€ê° ì‹œê°„ ìˆ˜ì • (ê´€ë¦¬ì ì „ìš©)
        async function editLateTime(recordId, currentLateMinutes) {
            const newLateMinutes = prompt('ìƒˆ ì§€ê° ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (ë¶„ ë‹¨ìœ„):', currentLateMinutes);
            if (newLateMinutes === null || newLateMinutes === currentLateMinutes.toString()) return;
            
            const lateMinutes = parseInt(newLateMinutes);
            if (isNaN(lateMinutes) || lateMinutes < 0) {
                showLoginAlert('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            
            try {
                const fine = calculateFine(lateMinutes);
                showLoginAlert(`ì§€ê°ì‹œê°„ ìˆ˜ì •: ${currentLateMinutes}ë¶„ â†’ ${lateMinutes}ë¶„\në²Œê¸ˆ: ${fine.toLocaleString()}ì›\nì‹¤ì œ ìˆ˜ì •ì€ Firebase ì½˜ì†”ì—ì„œ ì§ì ‘ í•´ì£¼ì„¸ìš”.`, 'warning');
            } catch (error) {
                console.error('ì§€ê°ì‹œê°„ ìˆ˜ì • ì‹¤íŒ¨:', error);
                showLoginAlert('ì§€ê°ì‹œê°„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }
        
        // ì¶œì„ ê¸°ë¡ ì‚­ì œ (ê´€ë¦¬ì ì „ìš©) - ì‹¤ì œ Firebase ì‚­ì œ êµ¬í˜„
        async function deleteAttendance(recordId, name) {
            if (!confirm(`"${name}"ë‹˜ì˜ ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }
            
            if (!window.db) {
                showLoginAlert('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'danger');
                return;
            }
            
            try {
                // Firebaseì—ì„œ ì‹¤ì œ ì‚­ì œ
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'attendance', recordId));
                showLoginAlert(`"${name}"ë‹˜ì˜ ì¶œì„ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } catch (error) {
                console.error('ì¶œì„ ê¸°ë¡ ì‚­ì œ ì‹¤íŒ¨:', error);
                showLoginAlert('ì¶œì„ ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'danger');
            }
        }
        
        // ëª¨ì„ ì‹œê°„ ì„¤ì • (Firebaseì— ì €ì¥)
        async function setMeetingTime() {
            const timeInput = document.getElementById('meeting-time').value;
            if (!timeInput) {
                showLoginAlert('ëª¨ì„ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            
            if (!window.db) {
                showLoginAlert('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'danger');
                return;
            }
            
            try {
                const today = new Date().toDateString();
                
                const meetingData = {
                    meetingTime: timeInput,
                    date: today,
                    timestamp: new Date().toISOString()
                };
                
                // ìƒˆë¡œ ì¶”ê°€ (Firestore íŠ¹ì„±ìƒ ì¤‘ë³µ ìƒì„±)
                await window.firestore.addDoc(window.firestore.collection(window.db, 'meetings'), meetingData);
                
                meetingTime = timeInput;
                updateMeetingTimeDisplay();
                showLoginAlert('ëª¨ì„ ì‹œê°„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ëª¨ë“  ì‚¬ìš©ìê°€ ì´ì œ ì¶œì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                console.error('ëª¨ì„ ì‹œê°„ ì„¤ì • ì‹¤íŒ¨:', error);
                showLoginAlert('ëª¨ì„ ì‹œê°„ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }
        
        // ëª¨ì„ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateMeetingTimeDisplay() {
            if (meetingTime) {
                const time = new Date(meetingTime);
                const displayElement = document.getElementById('current-meeting-time');
                if (displayElement) {
                    displayElement.innerHTML = 
                        `<span style="color: #28a745;">âœ… ì„¤ì •ëœ ëª¨ì„ ì‹œê°„: ${time.toLocaleString('ko-KR')}</span>`;
                }
            }
        }
        
        // ì§€ê° ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
        function calculateLateMinutes(checkInTime) {
            if (!meetingTime) {
                console.warn('ëª¨ì„ ì‹œê°„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return 0;
            }
            
            const meeting = new Date(meetingTime);
            const checkIn = new Date(checkInTime);
            const diffMs = checkIn - meeting;
            
            if (diffMs <= 0) return 0; // ì •ì‹œ ë˜ëŠ” ì¼ì° ë„ì°©
            
            return Math.ceil(diffMs / (1000 * 60)); // ë¶„ ë‹¨ìœ„ë¡œ ì˜¬ë¦¼
        }

        // ë²Œê¸ˆ ê³„ì‚° (ì„¤ì •ì— ë”°ë¼)
        function calculateFine(lateMinutes) {
            if (lateMinutes <= 0) return 0;
            
            // ì„¤ì •ëœ ìµœì†Œ ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ ê³„ì‚°
            const units = Math.ceil(lateMinutes / fineSettings.minUnit);
            return units * fineSettings.perMinute;
        }
        
        // URL íŒŒë¼ë¯¸í„° í™•ì¸
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'attend') {
                // ì¶œì„ ëª¨ë“œ
                document.getElementById('attendance-mode').classList.remove('hidden');
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('stats-only-mode').classList.add('hidden');
                document.getElementById('admin-mode').classList.add('hidden');
                
                if (savedUserName) {
                    document.getElementById('saved-name').textContent = savedUserName;
                    document.getElementById('saved-user').classList.remove('hidden');
                    document.getElementById('attend-btn').classList.add('hidden');
                }
            } else {
                // ë©”ì¸ ëª¨ë“œ - ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
                document.getElementById('attendance-mode').classList.add('hidden');
                document.getElementById('admin-login').classList.remove('hidden');
                document.getElementById('stats-only-mode').classList.add('hidden');
                document.getElementById('admin-mode').classList.add('hidden');
            }
        }
        
        // í†µê³„ë§Œ ë³´ê¸°
        function goToStats() {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('stats-only-mode').classList.remove('hidden');
            document.getElementById('admin-mode').classList.add('hidden');
            document.getElementById('attendance-mode').classList.add('hidden');
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
        function goToAdminLogin() {
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('stats-only-mode').classList.add('hidden');
            document.getElementById('admin-mode').classList.add('hidden');
            document.getElementById('attendance-mode').classList.add('hidden');
        }
        
        // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        function checkAdminPassword() {
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                sessionStorage.setItem('adminLoggedIn', 'true');
                
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('stats-only-mode').classList.add('hidden');
                document.getElementById('admin-mode').classList.remove('hidden');
                
                // QR ìƒì„± ë° ëª¨ì„ ì‹œê°„ ë¡œë“œ
                generateQR();
                loadMeetingTimeFromFirebase();
                
                showLoginAlert('ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            } else {
                showLoginAlert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.', 'danger');
                document.getElementById('admin-password').value = '';
            }
        }
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            isAdminLoggedIn = false;
            sessionStorage.removeItem('adminLoggedIn');
            
            document.getElementById('admin-mode').classList.add('hidden');
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('stats-only-mode').classList.add('hidden');
            document.getElementById('admin-password').value = '';
            
            showLoginAlert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
        }

        // ë¡œê·¸ì¸ ì•Œë¦¼ í‘œì‹œ
        function showLoginAlert(message, type) {
            const messageDiv = document.getElementById('login-message');
            messageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // Firebase ì—°ê²° ìƒíƒœ í™•ì¸
        function checkFirebaseConnection() {
            if (window.db) {
                document.getElementById('connection-status').className = 'connection-status connected';
                document.getElementById('connection-status').textContent = 'ğŸŸ¢ ì‹¤ì‹œê°„ ê³µìœ  ì—°ê²°ë¨';
                initializeApp();
                
                // ê´€ë¦¬ì í™”ë©´ì—ì„œ ê¸°ë³¸ ì‹œê°„ ì„¤ì •
                setTimeout(() => {
                    const meetingTimeInput = document.getElementById('meeting-time');
                    if (meetingTimeInput && !meetingTime) {
                        const now = new Date();
                        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                        meetingTimeInput.value = now.toISOString().slice(0, 16);
                    }
                }, 500);
            } else {
                document.getElementById('connection-status').className = 'connection-status disconnected';
                document.getElementById('connection-status').textContent = 'ğŸ”´ Firebase ì—°ê²° ì‹¤íŒ¨';
                showAlert('Firebase ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.', 'warning');
            }
        }
        
        // ì‹¤ì‹œê°„ ì¶œì„ ê¸°ë¡ ë¦¬ìŠ¤ë„ˆ
        function setupRealtimeListener() {
            if (!window.db) return;

            const today = new Date().toDateString();
            const q = window.firestore.query(
                window.firestore.collection(window.db, 'attendance'),
                window.firestore.where('date', '==', today)
            );

            unsubscribe = window.firestore.onSnapshot(q, (snapshot) => {
                const records = [];
                snapshot.forEach((doc) => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ (ìµœì‹ ìˆœ)
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // í†µê³„ ê³„ì‚°
                const lateCount = records.filter(r => r.lateMinutes > 0).length;
                const totalFine = records.reduce((sum, r) => sum + (r.fine || 0), 0);
                
                // ê´€ë¦¬ììš© í†µê³„ ì—…ë°ì´íŠ¸
                if (document.getElementById('total-count')) {
                    updateAttendanceDisplay(records);
                    document.getElementById('total-count').textContent = records.length;
                    document.getElementById('late-count').textContent = lateCount;
                    document.getElementById('total-fine').textContent = totalFine.toLocaleString() + 'ì›';
                }
                
                // ì¼ë°˜ ì‚¬ìš©ììš© í†µê³„ ì—…ë°ì´íŠ¸
                if (document.getElementById('total-count-public')) {
                    updatePublicAttendanceDisplay(records);
                    document.getElementById('total-count-public').textContent = records.length;
                    document.getElementById('late-count-public').textContent = lateCount;
                    document.getElementById('total-fine-public').textContent = totalFine.toLocaleString() + 'ì›';
                }
                
                attendanceCount = records.length;
            });
        }

        // ì¶œì„ ê¸°ë¡
        async function recordAttendance() {
            if (!window.db) {
                showAlert('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'danger');
                return;
            }

            // Firebaseì—ì„œ ìµœì‹  ëª¨ì„ ì‹œê°„ í™•ì¸
            if (!meetingTime) {
                await loadMeetingTimeFromFirebase();
            }

            if (!meetingTime) {
                showAlert('ê´€ë¦¬ìê°€ ëª¨ì„ ì‹œê°„ì„ ë¨¼ì € ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.', 'danger');
                return;
            }

            let userName;
            
            if (savedUserName && !document.getElementById('saved-user').classList.contains('hidden')) {
                userName = savedUserName;
            } else {
                userName = document.getElementById('user-name').value.trim();
                if (!userName) {
                    showAlert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                    return;
                }
                // ìƒˆ ì´ë¦„ ì €ì¥
                savedUserName = userName;
                localStorage.setItem('savedUserName', savedUserName);
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('attend-btn').disabled = true;
            document.getElementById('quick-attend-btn').disabled = true;
            
            try {
                // ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„í–ˆëŠ”ì§€ í™•ì¸
                const today = new Date().toDateString();
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'attendance'),
                    window.firestore.where('name', '==', userName),
                    window.firestore.where('date', '==', today)
                );
                
                const querySnapshot = await window.firestore.getDocs(q);
                
                if (!querySnapshot.empty) {
                    showAlert('ì˜¤ëŠ˜ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.', 'danger');
                    document.getElementById('attend-btn').disabled = false;
                    document.getElementById('quick-attend-btn').disabled = false;
                    return;
                }
                
                // ì¶œì„ ì‹œê°„ ë° ì§€ê° ê³„ì‚°
                const now = new Date();
                const lateMinutes = calculateLateMinutes(now.toISOString());
                const fine = calculateFine(lateMinutes);
                
                // ì¶œì„ ê¸°ë¡ ì €ì¥
                const record = {
                    name: userName,
                    timestamp: now.toISOString(),
                    date: now.toDateString(),
                    time: now.toLocaleTimeString('ko-KR'),
                    lateMinutes: lateMinutes,
                    fine: fine,
                    meetingTime: meetingTime
                };
                
                await window.firestore.addDoc(window.firestore.collection(window.db, 'attendance'), record);
                
                // UI ì •ë¦¬ (ëª¨ë“  ì…ë ¥ ìš”ì†Œ ìˆ¨ê¸°ê¸°)
                document.getElementById('name-section').classList.add('hidden');
                document.getElementById('saved-user').classList.add('hidden');
                document.getElementById('user-name').value = '';
                
                // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
                if (lateMinutes === 0) {
                    showAlert(`${userName}ë‹˜, ì •ì‹œ ì¶œì„ ì™„ë£Œ! ğŸ‰`, 'success');
                } else {
                    showAlert(`${userName}ë‹˜, ${lateMinutes}ë¶„ ì§€ê°ìœ¼ë¡œ ${fine.toLocaleString()}ì› ë²Œê¸ˆì…ë‹ˆë‹¤. ğŸ˜…`, 'warning');
                }
                
                // í†µê³„ ë³´ê¸° ë²„íŠ¼ ì¶”ê°€
                setTimeout(() => {
                    showStatsButton();
                }, 500);
                
                // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë‹¤ìŒ ì‚¬ëŒì„ ìœ„í•´)
                autoRefreshTimer = setTimeout(() => {
                    window.location.reload();
                }, 5000);
                
            } catch (error) {
                console.error('ì¶œì„ ê¸°ë¡ ì‹¤íŒ¨:', error);
                showAlert('ì¶œì„ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'danger');
            }
            
            // ë²„íŠ¼ ì¬í™œì„±í™”
            document.getElementById('attend-btn').disabled = false;
            document.getElementById('quick-attend-btn').disabled = false;
        }
        
        // ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì¶œì„
        function changeUser() {
            document.getElementById('saved-user').classList.add('hidden');
            document.getElementById('attend-btn').classList.remove('hidden');
            document.getElementById('user-name').value = '';
            document.getElementById('user-name').focus();
        }
        
        // íƒ­ ì „í™˜
        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }
        
        // ì˜¤ëŠ˜ ë°ì´í„° ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)
        async function clearTodayData() {
            if (!window.db) {
                showLoginAlert('Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'danger');
                return;
            }

            if (!confirm('âš ï¸ ì •ë§ë¡œ ì˜¤ëŠ˜ì˜ ëª¨ë“  ì¶œì„ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                const today = new Date().toDateString();
                const q = window.firestore.query(
                    window.firestore.collection(window.db, 'attendance'),
                    window.firestore.where('date', '==', today)
                );
                
                const querySnapshot = await window.firestore.getDocs(q);
                
                if (querySnapshot.empty) {
                    showLoginAlert('ì‚­ì œí•  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                // ëª¨ë“  ë¬¸ì„œ ì‚­ì œ
                const deletePromises = [];
                querySnapshot.forEach(doc => {
                    deletePromises.push(window.firestore.deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                showLoginAlert(`${querySnapshot.size}ê°œì˜ ì¶œì„ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
            } catch (error) {
                console.error('ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨:', error);
                showLoginAlert('ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'danger');
            }
        }

        // ê´€ë¦¬ììš© ì¶œì„ í˜„í™© ì—…ë°ì´íŠ¸ (ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ í¬í•¨)
        function updateAttendanceDisplay(records) {
            const listElement = document.getElementById('attendance-list');
            
            if (records.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: #666;">ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            listElement.innerHTML = records.map((record, index) => {
                const isLate = record.lateMinutes > 0;
                const statusColor = isLate ? '#ff6b6b' : '#28a745';
                const statusText = isLate ? `${record.lateMinutes}ë¶„ ì§€ê°` : 'ì •ì‹œ';
                const fineText = record.fine > 0 ? `${record.fine.toLocaleString()}ì›` : '-';
                
                return `
                    <div class="attendance-item" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div class="name" style="cursor: pointer;" onclick="editName('${record.id}', '${record.name}')">${index + 1}. ${record.name} âœï¸</div>
                                <div class="time">ì¶œì„: ${record.time}</div>
                                ${record.meetingTime ? `<div class="time" style="font-size: 0.8em; color: #999;">ëª¨ì„: ${new Date(record.meetingTime).toLocaleTimeString('ko-KR')}</div>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="color: ${statusColor}; font-weight: 600; margin-bottom: 5px;">
                                    ${statusText}
                                </div>
                                ${record.fine > 0 ? `<div style="color: #ff9f43; font-weight: 600;">ë²Œê¸ˆ: ${fineText}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="editLateTime('${record.id}', ${record.lateMinutes})" 
                                    style="padding: 5px 10px; border: none; background: #ffc107; color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                â° ì§€ê°ì‹œê°„ ìˆ˜ì •
                            </button>
                            <button onclick="deleteAttendance('${record.id}', '${record.name}')" 
                                    style="padding: 5px 10px; border: none; background: #dc3545; color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ì¼ë°˜ ì‚¬ìš©ììš© ì¶œì„ í˜„í™© ì—…ë°ì´íŠ¸ (ì½ê¸° ì „ìš©)
        function updatePublicAttendanceDisplay(records) {
            const listElement = document.getElementById('attendance-list-public');
            
            if (records.length === 0) {
                listElement.innerHTML = '<p style="text-align: center; color: #666;">ì˜¤ëŠ˜ ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            listElement.innerHTML = records.map((record, index) => {
                const isLate = record.lateMinutes > 0;
                const statusColor = isLate ? '#ff6b6b' : '#28a745';
                const statusText = isLate ? `${record.lateMinutes}ë¶„ ì§€ê°` : 'ì •ì‹œ';
                const fineText = record.fine > 0 ? `${record.fine.toLocaleString()}ì›` : '';
                
                return `
                    <div class="attendance-item">
                        <div>
                            <div class="name">${index + 1}. ${record.name}</div>
                            <div class="time">${record.time}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: ${statusColor}; font-weight: 600;">
                                ${statusText}
                            </div>
                            ${fineText ? `<div style="color: #ff9f43; font-size: 0.9em;">${fineText}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type) {
            const resultDiv = document.getElementById('result-message');
            resultDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        // QR ì½”ë“œ ìƒì„± (ê°€ì¥ ì•ˆì •ì ì¸ ë°©ì‹)
        function generateQR() {
            const attendanceUrl = currentUrl + '?action=attend';
            document.getElementById('attendance-url').textContent = attendanceUrl;
            
            // ì˜¨ë¼ì¸ QR ìƒì„± API ì‚¬ìš© (100% ì•ˆì •ì )
            const qrContainer = document.getElementById('qr-code');
            qrContainer.innerHTML = `
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(attendanceUrl)}" 
                     alt="ì¶œì„ QR ì½”ë“œ" 
                     style="border: 1px solid #ddd; border-radius: 10px; max-width: 100%;"
                     onload="console.log('QR ì½”ë“œ ë¡œë“œ ì™„ë£Œ')"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhkN2RhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzcyMWMyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkVSUk9SPC90ZXh0Pjwvc3ZnPg=='">
            `;
        }
        
        // URL ë³µì‚¬
        function copyUrl() {
            const url = document.getElementById('attendance-url').textContent;
            navigator.clipboard.writeText(url).then(() => {
                showLoginAlert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            });
        }
        
        // QR ì½”ë“œ ì¸ì‡„
        function printQR() {
            const qrElement = document.getElementById('qr-code');
            const url = document.getElementById('attendance-url').textContent;
            const qrImageSrc = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(url)}`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>ì¶œì„ QR ì½”ë“œ - ì˜êµ¬ ì‚¬ìš©</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 50px;
                        }
                        .qr-container { 
                            border: 3px solid #000; 
                            padding: 30px; 
                            display: inline-block;
                            margin: 20px;
                        }
                        h1 { font-size: 24px; margin-bottom: 20px; }
                        p { font-size: 16px; margin: 10px 0; }
                        .permanent { 
                            background: #e8f5e8; 
                            padding: 15px; 
                            border-radius: 10px; 
                            margin: 20px 0;
                            border: 2px solid #28a745;
                        }
                        .permanent h3 { color: #28a745; margin-bottom: 10px; }
                        .url { font-size: 12px; word-break: break-all; margin-top: 20px; color: #666; }
                    </style>
                </head>
                <body>
                    <h1>ğŸ“‹ ëª¨ì„ ì¶œì„ QR ì½”ë“œ</h1>
                    
                    <div class="permanent">
                        <h3>âœ… ì˜êµ¬ ì‚¬ìš© ê°€ëŠ¥</h3>
                        <p>ì´ QR ì½”ë“œëŠ” í•œ ë²ˆ ë¶™ì—¬ë‘ë©´ ê³„ì† ì‚¬ìš©ë©ë‹ˆë‹¤!</p>
                    </div>
                    
                    <div class="qr-container">
                        <img src="${qrImageSrc}" alt="ì¶œì„ QR ì½”ë“œ" style="width: 300px; height: 300px;">
                    </div>
                    
                    <p><strong>ì‚¬ìš© ë°©ë²•:</strong></p>
                    <p>1. QR ì½”ë“œ ìŠ¤ìº” â†’ ì¶œì„ í˜ì´ì§€ ìë™ ì´ë™</p>
                    <p>2. ì´ë¦„ ì…ë ¥ â†’ ì¶œì„í•˜ê¸° ë²„íŠ¼ í´ë¦­</p>
                    <p>3. ì§€ê° ì‹œ ìë™ìœ¼ë¡œ ë²Œê¸ˆ ê³„ì‚°ë©ë‹ˆë‹¤</p>
                    
                    <div class="url">${url}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Enter í‚¤ë¡œ ì¶œì„í•˜ê¸° ë° ê´€ë¦¬ì ë¡œê·¸ì¸
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('user-name');
            const passwordInput = document.getElementById('admin-password');
            
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        recordAttendance();
                    }
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkAdminPassword();
                    }
                });
            }
        });
        
        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            setTimeout(checkFirebaseConnection, 1000);
        });
        
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
            if (unsubscribeMeeting) unsubscribeMeeting();
            if (unsubscribeFineSettings) unsubscribeFineSettings(); // ì§€ê°ë¹„ ì„¤ì • ë¦¬ìŠ¤ë„ˆë„ ì •ë¦¬
        });
    </script>
</body>
</html>
